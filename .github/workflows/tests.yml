# From https://github.com/actions-rs/meta/blob/edeebc14493689cee04cb6d941c42c36a86e9d18/recipes/quickstart.md
name: tests

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  check:
    name: cargo check
    runs-on: ubuntu-latest
    container: 
      image: rust:latest 
    steps:
      - uses: actions/checkout@v2
      - run: cargo check
        
  test:
    name: cargo test
    runs-on: ubuntu-latest
    container: 
      image: rust:latest
    steps:
      - uses: actions/checkout@v2
      - run: cargo test
        
  fmt:
    name: cargo fmt
    runs-on: ubuntu-latest
    container: 
      image: rust:latest
    steps:
      - uses: actions/checkout@v2
      - run: |
          rustup component add rustfmt
          cargo fmt --all -- --check
          
  clippy:
    name: cargo clippy
    runs-on: ubuntu-latest
    container: 
      image: rust:latest
    steps:
      - uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - run: |
           rustup component add clippy
           cargo clippy --all-features -- -D clippy::all
  
  code-coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: read
    container:
      image: rust:latest
    steps:
      - uses: actions/checkout@v3
      - name: Update Rust and Install LLVM Tools
        run: | 
            rustup update stable
            rustup component add llvm-tools-preview
            cargo install cargo-llvm-cov
      - name: Generate Code Coverage and PR
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info 
      - uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          lcov-file: lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
  
  sbom:
   name: Syft SBOM Generator
   runs-on: ubuntu-20.04
   env:
    REPO_NAME: ${{ github.event.repository.name }}
    REPORT_FOLDER: ${{ github.event.repository.name }}-sbom-report
   steps:
       - uses: actions/checkout@v2
         with:
           token: ${{ secrets.GITHUB_TOKEN }}
       - run: |
           curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b .
           mkdir "${{ env.REPORT_FOLDER }}"
           ./syft .  --scope all-layers -o cyclonedx-xml=${{ env.REPORT_FOLDER }}/sbom-report.$(date "+%Y.%m.%d-%H.%M").xml
           ./syft .  --scope all-layers -o cyclonedx-json=${{ env.REPORT_FOLDER }}/sbom-report.$(date "+%Y.%m.%d-%H.%M").json
           cp ${{ env.REPORT_FOLDER }}/*.xml sbom-report.xml      
           curl -X 'POST' 'http://34.135.212.207:8081/api/v1/bom' \
                        -H 'Content-Type: multipart/form-data' \
                        -H 'X-API-Key: ${{ secrets.DEPENDENCYTRACK_APIKEY }}' \
                        -F 'autoCreate=true' \
                        -F 'projectVersion=1.0' \
                        -F "projectName=${{ env.REPO_NAME }}" \
                        -F 'bom=@sbom-report.xml'
       - uses: 'google-github-actions/auth@v1'
         with:
            credentials_json: '${{ secrets.GHA_SA_KEY }}'
       - uses: 'google-github-actions/upload-cloud-storage@v1'
         with:
            process_gcloudignore: false
            path: '${{ env.REPORT_FOLDER }}/'
            destination: 'security-sbom'